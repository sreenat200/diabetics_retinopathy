{% extends "base.html" %}

{% block title %}Analytics Dashboard - RetinaAI{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">Analytics Dashboard</h1>
            <p class="text-slate-500 text-sm mt-1">Deep learning insights for database records and patient history</p>
        </div>
        
        <div class="bg-slate-200/80 p-1.5 rounded-xl flex shadow-inner border border-slate-200/50 min-w-[340px]">
            <button id="tabOverall" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-bold shadow-sm bg-white text-blue-700 ring-1 ring-black/5 flex items-center justify-center gap-2 transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Overall Database
            </button>
            <button id="tabPatient" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-300/50 flex items-center justify-center gap-2 transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Patient Search
            </button>
        </div>
    </div>

    <div id="overallAnalyticsView" class="space-y-8 animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Total Patients</p>
                        <p class="text-2xl font-bold text-slate-900" id="totalPatients">0</p>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-xl">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Total Diagnoses</p>
                        <p class="text-2xl font-bold text-slate-900" id="totalDiagnoses">0</p>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-xl">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Healthy Cases</p>
                        <p class="text-2xl font-bold text-emerald-600" id="healthyCount">0</p>
                    </div>
                    <div class="p-3 bg-emerald-50 rounded-xl">
                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase mb-1">At Risk Cases</p>
                        <p class="text-2xl font-bold text-orange-600" id="atRiskCount">0</p>
                    </div>
                    <div class="p-3 bg-orange-50 rounded-xl">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m0 6v2m0-12H2m20 0h-2m2-4v2H2V7h20v2h2z"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Chart Comparison Dashboard</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Left Chart Type</label>
                    <select id="overallLeftChartSelector" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="diagnosisChart">Diagnosis Distribution</option>
                        <option value="severityChart">Severity Levels</option>
                        <option value="timelineChart">Diagnosis Timeline</option>
                        <option value="confidenceChart">Confidence Scores</option>
                        <option value="genderChart">Gender Distribution</option>
                        <option value="diagnosisByGenderChart">Diagnosis by Gender</option>
                        <option value="ageDistributionChart">Age Distribution</option>
                        <option value="riskByAgeChart">Risk by Age Group</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Right Chart Type</label>
                    <select id="overallRightChartSelector" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="severityChart">Severity Levels</option>
                        <option value="diagnosisChart">Diagnosis Distribution</option>
                        <option value="timelineChart">Diagnosis Timeline</option>
                        <option value="confidenceChart">Confidence Scores</option>
                        <option value="genderChart">Gender Distribution</option>
                        <option value="diagnosisByGenderChart">Diagnosis by Gender</option>
                        <option value="ageDistributionChart">Age Distribution</option>
                        <option value="riskByAgeChart">Risk by Age Group</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="relative h-80"><canvas id="overallLeftComparisonChart"></canvas></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="relative h-80"><canvas id="overallRightComparisonChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Diagnosis Statistics</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-slate-600">Diagnosis Type</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-slate-600">Count</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-slate-600">Percentage</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-slate-600">Avg Confidence</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="statisticsTableBody">
                        <tr><td colspan="4" class="text-center py-6 text-slate-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="overallConclusionSection" class="hidden mt-12 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-8 h-8 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2z" clip-rule="evenodd"></path></svg>
                Final Database Conclusion
            </h2>
            <p id="overallConclusionText" class="text-gray-700 text-lg leading-relaxed font-medium"></p>
        </div>
    </div>


    <div id="patientAnalyticsView" class="hidden space-y-8 animate-fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 relative">
                    <label class="block text-sm font-semibold text-slate-600 uppercase mb-2">Search by Patient Name</label>
                    <input type="text" id="patientNameSearch" placeholder="Type patient name..." class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <div id="patientDropdownList" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-lg shadow-lg z-10 max-h-64 overflow-y-auto"></div>
                </div>
                <div class="flex-1 relative">
                    <label class="block text-sm font-semibold text-slate-600 uppercase mb-2">Search by Patient ID</label>
                    <input type="text" id="patientIdSearch" placeholder="Enter Patient ID..." class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <div id="patientIdDropdownList" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-lg shadow-lg z-10 max-h-64 overflow-y-auto"></div>
                </div>
                <button id="loadPatientBtn" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">Load Analytics</button>
            </div>
        </div>

        <div id="patientInfoContainer" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Patient Name</p>
                    <p class="text-lg font-bold text-slate-900" id="patientName">-</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Patient ID</p>
                    <p class="text-lg font-bold text-slate-900" id="patientID">-</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Total Diagnoses</p>
                    <p class="text-lg font-bold text-slate-900" id="patientTotalDiagnoses">-</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Latest Status</p>
                    <p class="text-lg font-bold" id="patientLatestStatus">-</p>
                </div>
            </div>
        </div>

        <div id="metricsContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Latest Diagnosis</p>
                <p class="text-2xl font-bold text-slate-900" id="latestDiagnosis">-</p>
                <p class="text-xs text-slate-500 mt-2" id="latestDiagnosisDate">-</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Latest Confidence</p>
                <p class="text-2xl font-bold text-blue-600" id="latestConfidence">-</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Diagnosis History</p>
                <p class="text-2xl font-bold text-slate-900" id="diagnosisCount">0</p>
                <p class="text-xs text-slate-500 mt-2">records</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Current Risk Level</p>
                <p class="text-2xl font-bold" id="riskLevel">-</p>
            </div>
        </div>

        <div id="patientComparisonContainer" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Patient Charts</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Left Chart Type</label>
                    <select id="patientLeftChartSelector" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="evolutionChart">Diagnosis Evolution</option>
                        <option value="confidenceTrendChart">Confidence Trend</option>
                        <option value="patientDiagnosisChart">Diagnosis Distribution</option>
                        <option value="patientSeverityChart">Severity Levels</option>
                        <option value="confidenceDistributionChart">Confidence Distribution</option>
                        <option value="monthlyTrendChart">Monthly Trend</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Right Chart Type</label>
                    <select id="patientRightChartSelector" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="confidenceTrendChart">Confidence Trend</option>
                        <option value="evolutionChart">Diagnosis Evolution</option>
                        <option value="patientDiagnosisChart">Diagnosis Distribution</option>
                        <option value="patientSeverityChart">Severity Levels</option>
                        <option value="confidenceDistributionChart">Confidence Distribution</option>
                        <option value="monthlyTrendChart">Monthly Trend</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="relative h-80"><canvas id="patientLeftComparisonChart"></canvas></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="relative h-80"><canvas id="patientRightComparisonChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="additionalChartsContainer" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Confidence Score Distribution</h3>
                <div class="relative h-80"><canvas id="confidenceDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Monthly Diagnosis Trend</h3>
                <div class="relative h-80"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
        </div>

        <div id="historyTableContainer" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Complete Diagnosis History</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-slate-600">Date</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-slate-600">Diagnosis</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-slate-600">Confidence</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-slate-600">Confidence %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="patientHistoryTableBody">
                        <tr><td colspan="4" class="text-center py-6 text-slate-500">Select a patient to view history</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="statisticsContainer" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Statistics Summary</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Average Confidence</p>
                    <p class="text-2xl font-bold text-slate-900" id="avgConfidence">-</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Highest Confidence</p>
                    <p class="text-2xl font-bold text-slate-900" id="maxConfidence">-</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Lowest Confidence</p>
                    <p class="text-2xl font-bold text-slate-900" id="minConfidence">-</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Most Frequent</p>
                    <p class="text-2xl font-bold text-slate-900" id="frequentDiagnosis">-</p>
                </div>
            </div>
        </div>

        <div id="patientConclusionSection" class="hidden mt-12 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-8 h-8 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2z" clip-rule="evenodd"></path></svg>
                Current Final Patient Conclusion
            </h2>
            <p id="patientConclusionText" class="text-gray-700 text-lg leading-relaxed font-medium"></p>
        </div>
        
        <div id="emptyState" class="bg-white p-12 rounded-2xl shadow-sm border border-slate-100 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p class="text-slate-500 font-medium">Select a patient to view their analytics</p>
        </div>
    </div>
</div>

<script>
    // SHARED DATA
    const patientsData = {{ patients_json| tojson }};

    // ==========================================
    // VIEW SWITCHING LOGIC
    // ==========================================
    const tabOverall = document.getElementById('tabOverall');
    const tabPatient = document.getElementById('tabPatient');
    const overallView = document.getElementById('overallAnalyticsView');
    const patientView = document.getElementById('patientAnalyticsView');

    // Define classes for active and inactive states
    const activeClasses = ['bg-white', 'text-blue-700', 'shadow-sm', 'font-bold', 'ring-1', 'ring-black/5'];
    const inactiveClasses = ['text-slate-600', 'hover:text-slate-900', 'hover:bg-slate-300/50', 'font-medium'];

    function switchView(viewName) {
        if (viewName === 'overall') {
            overallView.classList.remove('hidden');
            patientView.classList.add('hidden');
            
            // Style Tabs
            tabOverall.classList.add(...activeClasses);
            tabOverall.classList.remove(...inactiveClasses);
            
            tabPatient.classList.remove(...activeClasses);
            tabPatient.classList.add(...inactiveClasses);
            
            // Trigger chart update for overall
            renderOverallComparisonCharts();
        } else {
            overallView.classList.add('hidden');
            patientView.classList.remove('hidden');
            
            // Style Tabs
            tabPatient.classList.add(...activeClasses);
            tabPatient.classList.remove(...inactiveClasses);
            
            tabOverall.classList.remove(...activeClasses);
            tabOverall.classList.add(...inactiveClasses);
            
            // Trigger data update for patient if a patient is selected
            if (selectedPatient) {
                renderPatientComparisonCharts();
                renderPatientAdditionalCharts();
                populatePatientHistoryTable();      // Added call to ensure table refreshes
                updatePatientStatisticsSummary();   // Added call to ensure stats refresh
                generatePatientConclusion();        // Added call to ensure conclusion refreshes
            }
        }
    }

    tabOverall.addEventListener('click', () => switchView('overall'));
    tabPatient.addEventListener('click', () => switchView('patient'));

    // ==========================================
    // PART 1: OVERALL ANALYTICS LOGIC
    // ==========================================
    let overallChartInstances = {};

    function initializeOverallCharts() {
        calculateOverallMetrics();
        renderOverallComparisonCharts();
        populateOverallStatisticsTable();
    }

    function calculateOverallMetrics() {
        let totalPatients = patientsData.length;
        let totalDiagnoses = 0;
        let healthyCount = 0;
        let atRiskCount = 0;

        patientsData.forEach(patient => {
            totalDiagnoses += patient.diagnoses.length;
            if (patient.diagnoses.length > 0) {
                const latestDiagnosis = patient.diagnoses[0];
                if (latestDiagnosis.class_name === 'No DR') {
                    healthyCount++;
                } else {
                    atRiskCount++;
                }
            }
        });

        document.getElementById('totalPatients').textContent = totalPatients;
        document.getElementById('totalDiagnoses').textContent = totalDiagnoses;
        document.getElementById('healthyCount').textContent = healthyCount;
        document.getElementById('atRiskCount').textContent = atRiskCount;
    }

    const overallChartConfigs = {
        diagnosisChart: {
            type: 'doughnut',
            data: () => {
                const diagnosisCounts = { 'No DR': 0, 'Mild': 0, 'Moderate': 0, 'Severe': 0, 'Proliferative': 0 };
                patientsData.forEach(patient => {
                    if (patient.diagnoses.length > 0) {
                        const latestDiagnosis = patient.diagnoses[0];
                        if (diagnosisCounts.hasOwnProperty(latestDiagnosis.class_name)) {
                            diagnosisCounts[latestDiagnosis.class_name]++;
                        }
                    }
                });
                return {
                    labels: ['No DR', 'Mild', 'Moderate', 'Severe', 'Proliferative'],
                    datasets: [{
                        data: Object.values(diagnosisCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#f97316', '#ef4444', '#dc2626'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } }
            }
        },
        severityChart: {
            type: 'bar',
            data: () => {
                const severityCounts = { 'No DR': 0, 'Mild/Moderate': 0, 'Severe/Proliferative': 0 };
                patientsData.forEach(patient => {
                    if (patient.diagnoses.length > 0) {
                        const latestDiagnosis = patient.diagnoses[0];
                        if (latestDiagnosis.class_name === 'No DR') severityCounts['No DR']++;
                        else if (['Mild', 'Moderate'].includes(latestDiagnosis.class_name)) severityCounts['Mild/Moderate']++;
                        else severityCounts['Severe/Proliferative']++;
                    }
                });
                return {
                    labels: ['No DR', 'Mild/Moderate', 'Severe/Proliferative'],
                    datasets: [{
                        label: 'Number of Patients',
                        data: Object.values(severityCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        },
        timelineChart: {
            type: 'line',
            data: () => {
                const monthlyData = {};
                for (let i = 0; i < 6; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - (5 - i));
                    const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    monthlyData[monthKey] = 0;
                }
                patientsData.forEach(patient => {
                    patient.diagnoses.forEach(diagnosis => {
                        const diagDate = new Date(diagnosis.created_at);
                        const monthKey = diagDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        if (monthlyData.hasOwnProperty(monthKey)) monthlyData[monthKey]++;
                    });
                });
                return {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'Diagnoses per Month',
                        data: Object.values(monthlyData),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        },
        confidenceChart: {
            type: 'bar',
            data: () => {
                const confidenceBuckets = { '0-20%': 0, '20-40%': 0, '40-60%': 0, '60-80%': 0, '80-100%': 0 };
                patientsData.forEach(patient => {
                    patient.diagnoses.forEach(diagnosis => {
                        const conf = diagnosis.confidence_percent;
                        if (conf < 20) confidenceBuckets['0-20%']++;
                        else if (conf < 40) confidenceBuckets['20-40%']++;
                        else if (conf < 60) confidenceBuckets['40-60%']++;
                        else if (conf < 80) confidenceBuckets['60-80%']++;
                        else confidenceBuckets['80-100%']++;
                    });
                });
                return {
                    labels: Object.keys(confidenceBuckets),
                    datasets: [{
                        label: 'Number of Diagnoses',
                        data: Object.values(confidenceBuckets),
                        backgroundColor: '#8b5cf6',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        },
        genderChart: {
            type: 'pie',
            data: () => {
                const genderCounts = {};
                patientsData.forEach(patient => {
                    const gender = patient.gender || 'Unknown';
                    genderCounts[gender] = (genderCounts[gender] || 0) + 1;
                });
                const colors = ['#3b82f6', '#ec4899', '#f59e0b'];
                return {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: colors.slice(0, Object.keys(genderCounts).length),
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } }
            }
        },
        diagnosisByGenderChart: {
            type: 'bar',
            data: () => {
                const genders = {};
                patientsData.forEach(patient => {
                    const gender = patient.gender || 'Unknown';
                    if (!genders[gender]) genders[gender] = { 'No DR': 0, 'At Risk': 0 };
                    if (patient.diagnoses.length > 0) {
                        const latestDiagnosis = patient.diagnoses[0];
                        if (latestDiagnosis.class_name === 'No DR') genders[gender]['No DR']++;
                        else genders[gender]['At Risk']++;
                    }
                });
                const genderLabels = Object.keys(genders);
                return {
                    labels: genderLabels,
                    datasets: [
                        { label: 'No DR', data: genderLabels.map(g => genders[g]['No DR']), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'At Risk', data: genderLabels.map(g => genders[g]['At Risk']), backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        },
        ageDistributionChart: {
            type: 'bar',
            data: () => {
                const ageBuckets = { '0-20': 0, '21-40': 0, '41-60': 0, '61-80': 0, '81+': 0 };
                patientsData.forEach(patient => {
                    const age = patient.age || 0;
                    if (age <= 20) ageBuckets['0-20']++;
                    else if (age <= 40) ageBuckets['21-40']++;
                    else if (age <= 60) ageBuckets['41-60']++;
                    else if (age <= 80) ageBuckets['61-80']++;
                    else ageBuckets['81+']++;
                });
                return {
                    labels: Object.keys(ageBuckets),
                    datasets: [{
                        label: 'Number of Patients',
                        data: Object.values(ageBuckets),
                        backgroundColor: '#06b6d4',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        },
        riskByAgeChart: {
            type: 'bar',
            data: () => {
                const ageRiskData = { '0-20': { 'No DR': 0, 'At Risk': 0 }, '21-40': { 'No DR': 0, 'At Risk': 0 }, '41-60': { 'No DR': 0, 'At Risk': 0 }, '61-80': { 'No DR': 0, 'At Risk': 0 }, '81+': { 'No DR': 0, 'At Risk': 0 } };
                patientsData.forEach(patient => {
                    const age = patient.age || 0;
                    let ageGroup = '81+';
                    if (age <= 20) ageGroup = '0-20';
                    else if (age <= 40) ageGroup = '21-40';
                    else if (age <= 60) ageGroup = '41-60';
                    else if (age <= 80) ageGroup = '61-80';

                    if (patient.diagnoses.length > 0) {
                        const latestDiagnosis = patient.diagnoses[0];
                        if (latestDiagnosis.class_name === 'No DR') ageRiskData[ageGroup]['No DR']++;
                        else ageRiskData[ageGroup]['At Risk']++;
                    }
                });
                const ageGroups = Object.keys(ageRiskData);
                return {
                    labels: ageGroups,
                    datasets: [
                        { label: 'No DR', data: ageGroups.map(group => ageRiskData[group]['No DR']), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'At Risk', data: ageGroups.map(group => ageRiskData[group]['At Risk']), backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                };
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } }, x: { grid: { color: '#e2e8f0' } } }
            }
        }
    };

    function renderOverallComparisonCharts() {
        const leftChartType = document.getElementById('overallLeftChartSelector').value;
        const rightChartType = document.getElementById('overallRightChartSelector').value;
        renderOverallChart('overallLeftComparisonChart', leftChartType);
        renderOverallChart('overallRightComparisonChart', rightChartType);
    }

    function renderOverallChart(canvasId, chartType) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;

        const ctx = canvas.getContext('2d');
        if (overallChartInstances[canvasId]) {
            overallChartInstances[canvasId].destroy();
        }
        const config = overallChartConfigs[chartType];
        if (config) {
            overallChartInstances[canvasId] = new Chart(ctx, {
                type: config.type,
                data: config.data(),
                options: config.options
            });
        }
    }

    function populateOverallStatisticsTable() {
        const diagnosisCounts = {};
        const diagnosisConfidence = {};

        patientsData.forEach(patient => {
            patient.diagnoses.forEach(diagnosis => {
                if (!diagnosisCounts[diagnosis.class_name]) {
                    diagnosisCounts[diagnosis.class_name] = 0;
                    diagnosisConfidence[diagnosis.class_name] = [];
                }
                diagnosisCounts[diagnosis.class_name]++;
                diagnosisConfidence[diagnosis.class_name].push(diagnosis.confidence_percent);
            });
        });

        const totalDiagnoses = Object.values(diagnosisCounts).reduce((a, b) => a + b, 0);
        const tbody = document.getElementById('statisticsTableBody');
        tbody.innerHTML = '';

        Object.keys(diagnosisCounts).sort().forEach(diagnosisType => {
            const count = diagnosisCounts[diagnosisType];
            const percentage = ((count / totalDiagnoses) * 100).toFixed(2);
            const avgConfidence = (
                diagnosisConfidence[diagnosisType].reduce((a, b) => a + b, 0) /
                diagnosisConfidence[diagnosisType].length
            ).toFixed(2);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-3 text-sm text-slate-800 font-medium">${diagnosisType}</td>
                <td class="px-6 py-3 text-center text-sm text-slate-600">${count}</td>
                <td class="px-6 py-3 text-center text-sm text-slate-600">${percentage}%</td>
                <td class="px-6 py-3 text-center text-sm text-slate-600">${avgConfidence}%</td>
            `;
            tbody.appendChild(row);
        });
    }

    function generateOverallConclusion() {
        if (!patientsData || patientsData.length === 0) return;
        const classCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
        
        patientsData.forEach(patient => {
            patient.diagnoses.forEach(diagnosis => {
                let classId = 0;
                if (diagnosis.class_name === 'No DR') classId = 0;
                else if (diagnosis.class_name === 'Mild') classId = 1;
                else if (diagnosis.class_name === 'Moderate') classId = 2;
                else if (diagnosis.class_name === 'Severe') classId = 3;
                else if (diagnosis.class_name === 'Proliferative') classId = 4;
                classCount[classId]++;
            });
        });
        
        const maxCount = Math.max(...Object.values(classCount));
        let mostCommonClass = 0;
        for (let classId in classCount) {
            if (classCount[classId] === maxCount) {
                mostCommonClass = parseInt(classId);
                break;
            }
        }
        
        let conclusionText = '';
        if (mostCommonClass === 0) {
            conclusionText = 'âœ“ No signs of Diabetic Retinopathy detected for patients. Analysis of stored patient records shows predominantly healthy retinal status.';
        } else if (mostCommonClass === 1 || mostCommonClass === 2) {
            conclusionText = 'âš ï¸ Early-stage Diabetic Retinopathy detected for some patients. Database analysis indicates a predominance of mild to moderate cases. Follow-up evaluations recommended within 3-6 months.';
        } else if (mostCommonClass === 3 || mostCommonClass === 4) {
            conclusionText = 'ðŸ”´ Advanced Diabetic Retinopathy detected for some patients. Database analysis shows significant prevalence of severe or proliferative cases. Immediate medical intervention required for affected patients.';
        }
        
        document.getElementById('overallConclusionText').textContent = conclusionText;
        document.getElementById('overallConclusionSection').classList.remove('hidden');
    }

    // ==========================================
    // PART 2: PATIENT ANALYTICS LOGIC
    // ==========================================
    let selectedPatient = null;
    let selectedPatientId = null;
    let patientCharts = {};
    let patientComparisonCharts = {};

    const patientChartConfigs = {
        evolutionChart: {
            type: 'bar',
            data: () => {
                const sortedDiagnoses = [...selectedPatient.diagnoses].reverse();
                return {
                    labels: sortedDiagnoses.map((d, i) => `Visit ${i + 1}`),
                    datasets: [{
                        label: 'Diagnosis',
                        data: sortedDiagnoses.map(d => {
                            const val = { 'No DR': 0, 'Mild': 1, 'Moderate': 2, 'Severe': 3, 'Proliferative': 4 };
                            return val[d.class_name] || 0;
                        }),
                        backgroundColor: sortedDiagnoses.map(d => {
                            const col = { 'No DR': '#10b981', 'Mild': '#f59e0b', 'Moderate': '#f97316', 'Severe': '#ef4444', 'Proliferative': '#dc2626' };
                            return col[d.class_name] || '#6b7280';
                        }),
                        borderRadius: 6
                    }]
                };
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true, max: 4,
                        ticks: { callback: function(value) { return ['No DR', 'Mild', 'Moderate', 'Severe', 'Proliferative'][value] || ''; } }
                    }
                }
            }
        },
        confidenceTrendChart: {
            type: 'line',
            data: () => {
                const sortedDiagnoses = [...selectedPatient.diagnoses].reverse();
                return {
                    labels: sortedDiagnoses.map((d, i) => `Visit ${i + 1}`),
                    datasets: [{
                        label: 'Confidence Score',
                        data: sortedDiagnoses.map(d => d.confidence_percent),
                        borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4, fill: true, pointRadius: 6, pointBackgroundColor: '#3b82f6', pointBorderColor: '#ffffff', pointBorderWidth: 2
                    }]
                };
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#e2e8f0' } } } }
        },
        patientDiagnosisChart: {
            type: 'doughnut',
            data: () => {
                const diagnosisCounts = {};
                selectedPatient.diagnoses.forEach(d => diagnosisCounts[d.class_name] = (diagnosisCounts[d.class_name] || 0) + 1);
                return {
                    labels: Object.keys(diagnosisCounts),
                    datasets: [{
                        data: Object.values(diagnosisCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#f97316', '#ef4444', '#dc2626'].slice(0, Object.keys(diagnosisCounts).length),
                        borderColor: '#ffffff', borderWidth: 2
                    }]
                };
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } } }
        },
        patientSeverityChart: {
            type: 'bar',
            data: () => {
                const severityCounts = { 'No DR': 0, 'Mild/Moderate': 0, 'Severe/Proliferative': 0 };
                selectedPatient.diagnoses.forEach(d => {
                    if (d.class_name === 'No DR') severityCounts['No DR']++;
                    else if (['Mild', 'Moderate'].includes(d.class_name)) severityCounts['Mild/Moderate']++;
                    else severityCounts['Severe/Proliferative']++;
                });
                return {
                    labels: ['No DR', 'Mild/Moderate', 'Severe/Proliferative'],
                    datasets: [{
                        label: 'Count', data: Object.values(severityCounts), backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderRadius: 6
                    }]
                };
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: '#e2e8f0' } } } }
        },
        confidenceDistributionChart: {
            type: 'bar',
            data: () => {
                const confidenceBuckets = { '0-20%': 0, '20-40%': 0, '40-60%': 0, '60-80%': 0, '80-100%': 0 };
                selectedPatient.diagnoses.forEach(d => {
                    const conf = d.confidence_percent;
                    if (conf < 20) confidenceBuckets['0-20%']++;
                    else if (conf < 40) confidenceBuckets['20-40%']++;
                    else if (conf < 60) confidenceBuckets['40-60%']++;
                    else if (conf < 80) confidenceBuckets['60-80%']++;
                    else confidenceBuckets['80-100%']++;
                });
                return {
                    labels: Object.keys(confidenceBuckets),
                    datasets: [{ label: 'Number of Diagnoses', data: Object.values(confidenceBuckets), backgroundColor: '#8b5cf6', borderRadius: 6, borderSkipped: false }]
                };
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } } }
        },
        monthlyTrendChart: {
            type: 'line',
            data: () => {
                const monthlyData = {};
                for (let i = 0; i < 6; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - (5 - i));
                    monthlyData[date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })] = 0;
                }
                selectedPatient.diagnoses.forEach(d => {
                    const monthKey = new Date(d.created_at).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    if (monthlyData.hasOwnProperty(monthKey)) monthlyData[monthKey]++;
                });
                return {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'Diagnoses per Month', data: Object.values(monthlyData), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4, fill: true, pointRadius: 5, pointBackgroundColor: '#10b981', pointBorderColor: '#ffffff', pointBorderWidth: 2
                    }]
                };
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { size: 12, family: "'Inter', sans-serif" }, color: '#475569' } } }, scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } } }
        }
    };

    function initializePatientSearch() {
        const searchInput = document.getElementById('patientNameSearch');
        const dropdownList = document.getElementById('patientDropdownList');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm.length === 0) { dropdownList.classList.add('hidden'); return; }

            const filteredPatients = patientsData.filter(patient => `${patient.first_name} ${patient.last_name}`.toLowerCase().includes(searchTerm)).slice(0, 10);
            dropdownList.innerHTML = '';
            
            if (filteredPatients.length === 0) {
                dropdownList.innerHTML = '<div class="px-4 py-3 text-slate-500 text-sm">No patients found</div>';
                dropdownList.classList.remove('hidden');
                return;
            }

            filteredPatients.forEach(patient => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2.5 hover:bg-blue-50 cursor-pointer text-sm border-b border-slate-100 last:border-b-0 transition-colors';
                option.innerHTML = `<div class="font-medium text-slate-900">${patient.first_name} ${patient.last_name}</div><div class="text-xs text-slate-500">ID: ${patient.medical_id || 'N/A'}</div>`;
                option.addEventListener('click', function() {
                    selectedPatientId = patient.id;
                    searchInput.value = `${patient.first_name} ${patient.last_name}`;
                    document.getElementById('patientIdSearch').value = patient.medical_id || '';
                    dropdownList.classList.add('hidden');
                    document.getElementById('patientIdDropdownList').classList.add('hidden');
                });
                dropdownList.appendChild(option);
            });
            dropdownList.classList.remove('hidden');
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('#patientNameSearch') && !event.target.closest('#patientDropdownList')) dropdownList.classList.add('hidden');
        });
    }

    function initializePatientIdSearch() {
        const searchInput = document.getElementById('patientIdSearch');
        const dropdownList = document.getElementById('patientIdDropdownList');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm.length === 0) { dropdownList.classList.add('hidden'); return; }

            const filteredPatients = patientsData.filter(patient => (patient.medical_id || '').toLowerCase().includes(searchTerm)).slice(0, 10);
            dropdownList.innerHTML = '';
            
            if (filteredPatients.length === 0) {
                dropdownList.innerHTML = '<div class="px-4 py-3 text-slate-500 text-sm">No patients found</div>';
                dropdownList.classList.remove('hidden');
                return;
            }

            filteredPatients.forEach(patient => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2.5 hover:bg-blue-50 cursor-pointer text-sm border-b border-slate-100 last:border-b-0 transition-colors';
                option.innerHTML = `<div class="font-medium text-slate-900">${patient.medical_id || 'N/A'}</div><div class="text-xs text-slate-500">Name: ${patient.first_name} ${patient.last_name}</div>`;
                option.addEventListener('click', function() {
                    selectedPatientId = patient.id;
                    searchInput.value = patient.medical_id || '';
                    document.getElementById('patientNameSearch').value = `${patient.first_name} ${patient.last_name}`;
                    dropdownList.classList.add('hidden');
                    document.getElementById('patientDropdownList').classList.add('hidden');
                });
                dropdownList.appendChild(option);
            });
            dropdownList.classList.remove('hidden');
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('#patientIdSearch') && !event.target.closest('#patientIdDropdownList')) dropdownList.classList.add('hidden');
        });
    }

    document.getElementById('loadPatientBtn').addEventListener('click', function() {
        const patientNameSearchValue = document.getElementById('patientNameSearch').value.trim();
        const patientIdFromSearch = document.getElementById('patientIdSearch').value.trim();
        let patientToLoad = null;

        if (selectedPatientId) {
            patientToLoad = patientsData.find(p => p.id === selectedPatientId);
        } else if (patientIdFromSearch) {
            patientToLoad = patientsData.find(p => p.medical_id === patientIdFromSearch);
            if (!patientToLoad) { alert('Patient ID not found.'); return; }
        } else if (patientNameSearchValue) {
            const matchedPatients = patientsData.filter(p => `${p.first_name} ${p.last_name}`.toLowerCase().includes(patientNameSearchValue.toLowerCase()));
            if (matchedPatients.length === 0) { alert('No patient found with that name.'); return; }
            patientToLoad = matchedPatients[0];
        } else {
            alert('Please select a patient or enter a Patient ID'); return;
        }

        if (patientToLoad) {
            selectedPatient = patientToLoad;
            displayPatientAnalytics();
        } else {
            alert('Patient not found');
        }
    });

    function displayPatientAnalytics() {
        document.getElementById('emptyState').classList.add('hidden');
        ['patientInfoContainer', 'metricsContainer', 'patientComparisonContainer', 'additionalChartsContainer', 'historyTableContainer', 'statisticsContainer'].forEach(id => document.getElementById(id).classList.remove('hidden'));
        
        updatePatientInfo();
        updatePatientMetrics();
        renderPatientComparisonCharts();
        renderPatientAdditionalCharts();
        populatePatientHistoryTable();
        updatePatientStatisticsSummary();
        generatePatientConclusion();
    }

    function updatePatientInfo() {
        const latestDiagnosis = selectedPatient.diagnoses.length > 0 ? selectedPatient.diagnoses[0] : null;
        let statusColor = 'text-slate-900', statusText = 'No Data';
        if (latestDiagnosis) {
            if (latestDiagnosis.class_name === 'No DR') { statusColor = 'text-emerald-600'; statusText = 'Healthy'; }
            else if (['Mild', 'Moderate'].includes(latestDiagnosis.class_name)) { statusColor = 'text-orange-600'; statusText = 'Monitor'; }
            else { statusColor = 'text-red-600'; statusText = 'Critical'; }
        }
        document.getElementById('patientName').textContent = `${selectedPatient.first_name} ${selectedPatient.last_name}`;
        document.getElementById('patientID').textContent = selectedPatient.medical_id || 'N/A';
        document.getElementById('patientTotalDiagnoses').textContent = selectedPatient.diagnoses.length;
        document.getElementById('patientLatestStatus').textContent = statusText;
        document.getElementById('patientLatestStatus').className = `text-lg font-bold ${statusColor}`;
    }

    function updatePatientMetrics() {
        const latestDiagnosis = selectedPatient.diagnoses.length > 0 ? selectedPatient.diagnoses[0] : null;
        if (latestDiagnosis) {
            document.getElementById('latestDiagnosis').textContent = latestDiagnosis.class_name;
            document.getElementById('latestDiagnosisDate').textContent = new Date(latestDiagnosis.created_at).toLocaleDateString();
            document.getElementById('latestConfidence').textContent = latestDiagnosis.confidence_percent.toFixed(2) + '%';
        } else {
            document.getElementById('latestDiagnosis').textContent = 'No Data';
            document.getElementById('latestDiagnosisDate').textContent = '-';
            document.getElementById('latestConfidence').textContent = '-';
        }
        document.getElementById('diagnosisCount').textContent = selectedPatient.diagnoses.length;
        
        let riskColor = 'text-slate-900', riskText = 'Unknown';
        if (latestDiagnosis) {
            if (latestDiagnosis.class_name === 'No DR') { riskColor = 'text-emerald-600'; riskText = 'Low'; }
            else if (['Mild', 'Moderate'].includes(latestDiagnosis.class_name)) { riskColor = 'text-orange-600'; riskText = 'Medium'; }
            else { riskColor = 'text-red-600'; riskText = 'High'; }
        }
        document.getElementById('riskLevel').textContent = riskText;
        document.getElementById('riskLevel').className = `text-2xl font-bold ${riskColor}`;
    }

    function renderPatientComparisonCharts() {
        renderPatientComparisonChart('patientLeftComparisonChart', document.getElementById('patientLeftChartSelector').value);
        renderPatientComparisonChart('patientRightComparisonChart', document.getElementById('patientRightChartSelector').value);
    }

    function renderPatientComparisonChart(canvasId, chartType) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if (patientComparisonCharts[canvasId]) patientComparisonCharts[canvasId].destroy();
        const config = patientChartConfigs[chartType];
        if (config) patientComparisonCharts[canvasId] = new Chart(ctx, { type: config.type, data: config.data(), options: config.options });
    }

    function renderPatientAdditionalCharts() {
        renderPatientChart('confidenceDistributionChart', 'confidenceDistributionChart');
        renderPatientChart('monthlyTrendChart', 'monthlyTrendChart');
    }

    function renderPatientChart(canvasId, chartType) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if (patientCharts[canvasId]) patientCharts[canvasId].destroy();
        const config = patientChartConfigs[chartType];
        if (config) patientCharts[canvasId] = new Chart(ctx, { type: config.type, data: config.data(), options: config.options });
    }

    // FIXED FUNCTION
    function populatePatientHistoryTable() {
        const tbody = document.getElementById('patientHistoryTableBody');
        tbody.innerHTML = '';
        
        if (!selectedPatient.diagnoses || selectedPatient.diagnoses.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4" class="text-center py-6 text-slate-500">No history available</td>`;
            tbody.appendChild(row);
            return;
        }

        selectedPatient.diagnoses.forEach(diagnosis => {
            // Calculate decimal confidence from percent to avoid 'undefined' error
            const decimalConfidence = (diagnosis.confidence_percent / 100).toFixed(4);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-3 text-sm text-slate-800">${new Date(diagnosis.created_at).toLocaleDateString()}</td>
                <td class="px-6 py-3 text-sm font-medium text-slate-800">${diagnosis.class_name}</td>
                <td class="px-6 py-3 text-center text-sm text-slate-600">${decimalConfidence}</td>
                <td class="px-6 py-3 text-center text-sm text-slate-600">${diagnosis.confidence_percent.toFixed(2)}%</td>
            `;
            tbody.appendChild(row);
        });
    }

    function updatePatientStatisticsSummary() {
        if (!selectedPatient || !selectedPatient.diagnoses) return;
        
        const confidences = selectedPatient.diagnoses.map(d => d.confidence_percent);
        const avgConf = confidences.length > 0 ? confidences.reduce((a, b) => a + b, 0) / confidences.length : 0;
        const maxConf = confidences.length > 0 ? Math.max(...confidences) : 0;
        const minConf = confidences.length > 0 ? Math.min(...confidences) : 0;
        
        const diagnosisCounts = {};
        selectedPatient.diagnoses.forEach(d => diagnosisCounts[d.class_name] = (diagnosisCounts[d.class_name] || 0) + 1);
        const frequentDiag = Object.keys(diagnosisCounts).length > 0 ? Object.keys(diagnosisCounts).reduce((a, b) => diagnosisCounts[a] > diagnosisCounts[b] ? a : b) : 'N/A';

        document.getElementById('avgConfidence').textContent = avgConf.toFixed(2) + '%';
        document.getElementById('maxConfidence').textContent = maxConf.toFixed(2) + '%';
        document.getElementById('minConfidence').textContent = minConf.toFixed(2) + '%';
        document.getElementById('frequentDiagnosis').textContent = frequentDiag;
    }

    function generatePatientConclusion() {
        if (!selectedPatient || !selectedPatient.diagnoses || selectedPatient.diagnoses.length === 0) return;
        const classCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
        selectedPatient.diagnoses.forEach(d => {
            let c = 0;
            if (d.class_name === 'No DR') c = 0; else if (d.class_name === 'Mild') c = 1; else if (d.class_name === 'Moderate') c = 2; else if (d.class_name === 'Severe') c = 3; else if (d.class_name === 'Proliferative') c = 4;
            classCount[c]++;
        });
        const maxCount = Math.max(...Object.values(classCount));
        let mostCommonClass = 0;
        for (let classId in classCount) { if (classCount[classId] === maxCount) { mostCommonClass = parseInt(classId); break; } }
        
        let conclusionText = '';
        if (mostCommonClass === 0) conclusionText = 'âœ“ No signs of Diabetic Retinopathy detected. Patient\'s records show predominantly healthy retinal status.';
        else if (mostCommonClass === 1 || mostCommonClass === 2) conclusionText = 'âš ï¸ Early-stage Diabetic Retinopathy detected. Patient\'s history indicates mild to moderate disease. Follow-up evaluation recommended within 3-6 months.';
        else if (mostCommonClass === 3 || mostCommonClass === 4) conclusionText = 'ðŸ”´ Advanced Diabetic Retinopathy detected. Patient\'s records show severe or proliferative disease. Immediate medical attention required.';
        
        document.getElementById('patientConclusionText').textContent = conclusionText;
        document.getElementById('patientConclusionSection').classList.remove('hidden');
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Overall Analytics
        initializeOverallCharts();
        
        // Initialize Patient Analytics inputs
        initializePatientSearch();
        initializePatientIdSearch();

        // Comparison Chart Listeners (Overall)
        document.getElementById('overallLeftChartSelector').addEventListener('change', function() { renderOverallChart('overallLeftComparisonChart', this.value); });
        document.getElementById('overallRightChartSelector').addEventListener('change', function() { renderOverallChart('overallRightComparisonChart', this.value); });

        // Comparison Chart Listeners (Patient)
        document.getElementById('patientLeftChartSelector').addEventListener('change', function() { renderPatientComparisonCharts(); });
        document.getElementById('patientRightChartSelector').addEventListener('change', function() { renderPatientComparisonCharts(); });

        // Generate Conclusions
        setTimeout(generateOverallConclusion, 500);
    });
</script>
{% endblock %}